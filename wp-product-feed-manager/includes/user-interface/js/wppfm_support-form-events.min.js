jQuery((function(){const authorizationUsername="listing_manager";const authorizationPassword="rxgbwedYS0XqF1AvkHNPbC06";const base64Auth=btoa(`${authorizationUsername}:${authorizationPassword}`);const apiURL="https://wpmarketingrobot.com/wp-json/fluent-crm/v2/subscribers/";jQuery("#wppfm-sign-up-button").on("click",(function(){let email=jQuery("#wppfm-sign-up-mail-input").val();const wpUserName=wppfm_getWpUserNames();email=wppfm_sanitizeEmail(email);if(!email){wppfm_showErrorMessage(wppfm_support_form_vars.email_not_valid);return}wppfm_sendSubscriber(wpUserName,email)}));jQuery(".wppfm-popup__close-button").on("click",(function(){jQuery("#wppfm-channel-info-popup").hide();jQuery("#wppfm-google-shopping-checklist-popup").hide()}));jQuery("#wppfm-accept-eula").on("change",(function(){if(jQuery(this).is(":checked")){jQuery("#wppfm-license-activate").prop("disabled",false)}else{jQuery("#wppfm-license-activate").prop("disabled",true)}}));function wppfm_sendSubscriber(wpUserName,email){wppfm_showWorkingSpinner();let params={first_name:wpUserName.firstName,last_name:wpUserName.lastName,email:email,status:"subscribed",tags:[1,11],lists:[6]};jQuery.ajax({method:"POST",url:apiURL,data:params,headers:{Authorization:"Basic "+base64Auth}}).done((function(){jQuery("#wppfm-google-shopping-checklist-popup").show();wppfm_hideWorkingSpinner()})).fail((function(xhr){wppfm_handleSubscriberFail(xhr,email)}))}function wppfm_getSubscriberId(email){let params={get_by_email:email};return new Promise(((resolve,reject)=>{jQuery.ajax({method:"GET",url:`${apiURL}0`,data:params,headers:{Authorization:"Basic "+base64Auth}}).done((function(result){resolve(result.subscriber.id)})).fail((function(xhr){reject(xhr)}))}))}function wppfm_updateSubscriberTagsToEBook(subscriberId){let params={attach_tags:[11]};return new Promise(((resolve,reject)=>{jQuery.ajax({method:"PUT",url:`${apiURL}${subscriberId}/`,data:params,headers:{Authorization:"Basic "+base64Auth}}).done((function(result){resolve(result)})).fail((function(xhr){reject(xhr)}))}))}function wppfm_handleSubscriberFail(xhr,email){let errorMessage=JSON.parse(xhr.responseText);let emailMessage=errorMessage.hasOwnProperty("email")?errorMessage.email:null;if(emailMessage&&emailMessage.hasOwnProperty("unique")){wppfm_getSubscriberId(email).then((subscriberId=>{wppfm_updateSubscriberTagsToEBook(subscriberId).then((result=>{if("Subscriber successfully updated"===result.message){jQuery("#wppfm-google-shopping-checklist-popup").show();wppfm_hideWorkingSpinner()}else{wppfm_handleSubscribeErrorMessage(result)}}))})).catch((xhr=>{wppfm_handleSubscribeErrorMessage(xhr)}))}else{wppfm_handleSubscribeErrorMessage(xhr)}}function wppfm_handleSubscribeErrorMessage(xhr){wppfm_showErrorMessage(wppfm_support_form_vars.signup_failed);console.log(JSON.parse(xhr.responseText));wppfm_hideWorkingSpinner()}function wppfm_getWpUserNames(){const dataStorageElement=jQuery("#wppfm-support-page-data-storage");const wpUserName=dataStorageElement.data("wppfmUsername");const firstName=dataStorageElement.data("wppfmUserFistName")||wpUserName;const lastName=dataStorageElement.data("wppfmUserLastName")||wpUserName;return{username:wpUserName,firstName:firstName,lastName:lastName}}}));